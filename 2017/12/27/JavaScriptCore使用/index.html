<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="JavaScriptCore," />










<meta name="description" content="JavaScriptCoreJavaScriptCore是webkit的一个重要组成部分，主要是对JS进行解析和提供执行环境。代码是开源的，可以下下来看看（源码）。iOS7后苹果在iPhone平台推出，极大的方便了我们对js的操作。我们可以脱离webview直接运行我们的js。iOS7以前我们对JS的操作只有webvi">
<meta name="keywords" content="JavaScriptCore">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScriptCore使用">
<meta property="og:url" content="http://www.521ios.com/2017/12/27/JavaScriptCore使用/index.html">
<meta property="og:site_name" content="你的激情被狗吃了吗">
<meta property="og:description" content="JavaScriptCoreJavaScriptCore是webkit的一个重要组成部分，主要是对JS进行解析和提供执行环境。代码是开源的，可以下下来看看（源码）。iOS7后苹果在iPhone平台推出，极大的方便了我们对js的操作。我们可以脱离webview直接运行我们的js。iOS7以前我们对JS的操作只有webview里面一个函数 stringByEvaluatingJavaScriptFro">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-01-12T09:50:05.881Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScriptCore使用">
<meta name="twitter:description" content="JavaScriptCoreJavaScriptCore是webkit的一个重要组成部分，主要是对JS进行解析和提供执行环境。代码是开源的，可以下下来看看（源码）。iOS7后苹果在iPhone平台推出，极大的方便了我们对js的操作。我们可以脱离webview直接运行我们的js。iOS7以前我们对JS的操作只有webview里面一个函数 stringByEvaluatingJavaScriptFro">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.521ios.com/2017/12/27/JavaScriptCore使用/"/>





  <title>JavaScriptCore使用 | 你的激情被狗吃了吗</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">你的激情被狗吃了吗</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">编程如逆水行舟，不进则退</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'F5xiKFBwG7sVaW7jqsDZ','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.521ios.com/2017/12/27/JavaScriptCore使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LiuXin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://pic2.52pk.com/files/141002/1283574_134905_7693.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你的激情被狗吃了吗">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JavaScriptCore使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-27T15:16:33+08:00">
                2017-12-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/27/JavaScriptCore使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/27/JavaScriptCore使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="JavaScriptCore"><a href="#JavaScriptCore" class="headerlink" title="JavaScriptCore"></a>JavaScriptCore</h3><p>JavaScriptCore是webkit的一个重要组成部分，主要是对JS进行解析和提供执行环境。代码是开源的，可以下下来看看<a href="https://github.com/phoboslab/JavaScriptCore-iOS" target="_blank" rel="noopener">（源码）</a>。iOS7后苹果在iPhone平台推出，极大的方便了我们对js的操作。我们可以脱离webview直接运行我们的js。iOS7以前我们对JS的操作只有webview里面一个函数 stringByEvaluatingJavaScriptFromString，JS对OC的回调都是基于URL的拦截进行的操作。大家用得比较多的是<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener">WebViewJavascriptBridge</a>和<a href="https://github.com/dukeland/EasyJSWebView" target="_blank" rel="noopener">EasyJSWebView</a>这两个开源库，很多混合都采用的这种方式。</p>
<a id="more"></a>
<p>JavaScriptCore和我们相关的类不是很多，使用起来也非常简单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;JSContext.h&quot;</span><br><span class="line">#import &quot;JSValue.h&quot;</span><br><span class="line">#import &quot;JSManagedValue.h&quot;</span><br><span class="line">#import &quot;JSVirtualMachine.h&quot;</span><br><span class="line">#import &quot;JSExport.h&quot;</span><br></pre></td></tr></table></figure>
<h3 id="JSContext"><a href="#JSContext" class="headerlink" title="JSContext"></a>JSContext</h3><p>JSContext 是JS代码的执行环境</p>
<p>JSContext 为JS代码的执行提供了上下文环境，通过jSCore执行的JS代码都得通过JSContext来执行。</p>
<p>JSContext对应于一个 JS 中的全局对象</p>
<p>JSContext对应着一个全局对象，相当于浏览器中的window对象，JSContext中有一个GlobalObject属性，实际上JS代码都是在这个GlobalObject上执行的，但是为了容易理解，可以把JSContext等价于全局对象。</p>
<h3 id="JSValue"><a href="#JSValue" class="headerlink" title="JSValue"></a>JSValue</h3><p>JSValue 是对 JS 值的包装</p>
<p>JSValue 顾名思义，就是JS值嘛，但是JS中的值拿到OC中是不能直接用的，需要包装一下，这个JSValue就是对JS值的包装，一个JSValue对应着一个JS值，这个JS值可能是JS中的number，boolean等基本类型，也可能是对象，函数，甚至可以是undefined，或者null。转换如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Objective-C type  |   JavaScript type</span><br><span class="line"> --------------------+---------------------</span><br><span class="line">         nil         |     undefined</span><br><span class="line">        NSNull       |        null</span><br><span class="line">       NSString      |       string</span><br><span class="line">       NSNumber      |   number, boolean</span><br><span class="line">     NSDictionary    |   Object object</span><br><span class="line">       NSArray       |    Array object</span><br><span class="line">        NSDate       |     Date object</span><br><span class="line">       NSBlock (1)   |   Function object (1)</span><br><span class="line">          id (2)     |   Wrapper object (2)</span><br><span class="line">        Class (3)    | Constructor object (3)</span><br></pre></td></tr></table></figure>
<p>其实，就相当于JS 中的 var。</p>
<p>JSValue存在于JSContext中</p>
<p>JSValue是不能独立存在的，它必须存在于某一个JSContext中，就像浏览器中所有的元素都包含于Window对象中一样，一个JSContext中可以包含多个JSValue。</p>
<p>都是强引用</p>
<p>这点很关键，JSValue对其对应的JS值和其所属的JSContext对象都是强引用的关系。因为jSValue需要这两个东西来执行JS代码，所以JSValue会一直持有着它们。</p>
<p>通过下面这些方法来创建一个JSValue对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (JSValue *)valueWithObject:(id)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithBool:(BOOL)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithDouble:(double)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithInt32:(int32_t)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithUInt32:(uint32_t)value inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithNewObjectInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithNewArrayInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithNewRegularExpressionFromPattern:(NSString *)pattern flags:(NSString *)flags inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithNewErrorFromMessage:(NSString *)message inContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithNullInContext:(JSContext *)context;</span><br><span class="line"></span><br><span class="line">+ (JSValue *)valueWithUndefinedInContext:(JSContext *)context;</span><br></pre></td></tr></table></figure>
<p>你可以将OC中的类型，转换成JS中的对应的类型（参见前面那个类型对照表），并包装在JSValue中，包括基本类型，Null和undfined。</p>
<p>或者你也可以创建一个新的对象，数组，正则表达式，错误，这几个方法达到的效果就相当于在JS中写 var a = new Array();</p>
<p>也可以将一个OC对象，转成JS中的对象，但是这样转换后的对象中的属性和方法，在JS中是获取不到的，怎样才能让JS中获取的OC对象中的属性和方法，我们后面再说。</p>
<h3 id="OC调用JS"><a href="#OC调用JS" class="headerlink" title="OC调用JS"></a>OC调用JS</h3><p>首先是一段JS代码，一个简单的递归函数，计算阶乘的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var factorial = function(n) &#123;</span><br><span class="line">    if (n &lt; 0)</span><br><span class="line">        return;</span><br><span class="line">    if (n === 0)</span><br><span class="line">        return 1;</span><br><span class="line">    return n * factorial(n - 1)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>OC中调用这个JS中的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//初始化JSContext</span><br><span class="line">self.context = [[JSContext alloc] init];</span><br><span class="line">//这句的效果就相当于在一个全局对象中声明了一个叫fatorial的函数，但是没有调用它，只是声明，所以执行完这段JS代码后没有返回值</span><br><span class="line">[self.context evaluateScript:[self loadJsFile:@&quot;OCCallJS&quot;]];</span><br><span class="line">    </span><br><span class="line">NSNumber *inputNumber = [NSNumber numberWithInteger:[self.textField.text integerValue]];</span><br><span class="line"></span><br><span class="line">//通过声明的JS方法名获取到这个函数</span><br><span class="line">JSValue *function = [self.context objectForKeyedSubscript:@&quot;factorial&quot;];</span><br><span class="line">//执行这个函数</span><br><span class="line">JSValue *result = [function callWithArguments:@[inputNumber]];</span><br><span class="line">//转换成对应的OC数据类型打印</span><br><span class="line">NSLog(@&quot;%d&quot;,[result toInt32]);</span><br><span class="line"></span><br><span class="line">// 方法二.</span><br><span class="line">// JSValue * function = self.context[@&quot;factorial&quot;];</span><br><span class="line">// JSValue *result = [function callWithArguments:@[inputNumber]];</span><br><span class="line">// NSLog(@&quot;%d&quot;,[result toInt32]);</span><br></pre></td></tr></table></figure>
<p>首先，从bundle中加载这段JS代码。</p>
<p>然后，创建一个JSContext，并用他来执行这段JS代码，这句的效果就相当于在一个全局对象中声明了一个叫fatorial的函数，但是没有调用它，只是声明，所以执行完这段JS代码后没有返回值。</p>
<p>再从这个全局对象中获取这个函数，这里我们用到了一种类似字典的下标写法来获取对应的JS函数，就像在一个字典中取这个key对应的value一样简单，实际上，JS中的对象就是以 key : Value 的形式存储属性的，且JS中的object对象类型，对应到OC中就是字典类型，所以这种写法自然且合理。</p>
<p>这种类似字典的下标方式不仅可以取值，也可以存值。不仅可以作用于Context，也可以作用与JSValue，他会用中括号中填的key值去匹配JSValue包含的JS值中有没有对应的属性字段，找到了就返回，没找到就返回undefined。</p>
<p>然后，我们拿到了包装这个阶乘函数的的JSValue对象，在其上调用callWithArguments方法，即可调用该函数，这个方法接收一个数组为参数，这是因为JS中的函数的参数都不是固定的，我们构建了一个数组，并把NSNumber类型的值传了过去，然而JS肯定是不知道什么是NSNumber的，但是别担心，JSCore会帮我们自动转换JS中对应的类型， 这里会把NSNumber类型的值转成JS中number类型的值，然后再去调用这个函数。</p>
<p>最后，如果函数有返回值，就会将函数返回值返回，如果没有返回值则返回undefined，当然在经过JSCore之后，这些JS中的类型都被包装成了JSValue，最后我们拿到返回的JSValue对象，转成对应的类型并输出。</p>
<h3 id="JS调用OC"><a href="#JS调用OC" class="headerlink" title="JS调用OC"></a>JS调用OC</h3><p>JavaScript 与 Objective-C 交互主要通过2种方式：</p>
<p>1.Block : 第一种方式是使用block，block也可以称作闭包和匿名函数，使用block可以很方便的将OC中的单个方法暴露给JS调用。</p>
<p>2.JSExport 协议 : 第二种方式，是使用JSExport协议，可以将OC的中某个对象直接暴露给JS使用，而且在JS中使用就像调用JS的对象一样自然。</p>
<h4 id="Block方式"><a href="#Block方式" class="headerlink" title="Block方式"></a>Block方式</h4><p>首先看Html和JS代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">	&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi&quot;&gt;</span><br><span class="line">	&lt;title&gt;JS调用OC&lt;/title&gt;</span><br><span class="line">	&lt;style&gt;</span><br><span class="line">		*</span><br><span class="line">		&#123;</span><br><span class="line">			//-webkit-tap-highlight-color: rgba(0,0,0,0);</span><br><span class="line">			text-decoration: none;</span><br><span class="line">		&#125;</span><br><span class="line">		html,body</span><br><span class="line">		&#123;</span><br><span class="line">			 -webkit-touch-callout: none;                /* prevent callout to copy image, etc when tap to hold */</span><br><span class="line">            -webkit-text-size-adjust: none;             /* prevent webkit from resizing text to fit */</span><br><span class="line">            -webkit-user-select: none;                  /* prevent copy paste, to allow, change &apos;none&apos; to &apos;text&apos; */</span><br><span class="line">		&#125;</span><br><span class="line">		#div-a</span><br><span class="line">		&#123;</span><br><span class="line">			background:#FBA;</span><br><span class="line">            color:#FFF;</span><br><span class="line">		&#125;</span><br><span class="line">	&lt;/style&gt;</span><br><span class="line">	&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">        </span><br><span class="line">        function showResult(resultNumber)</span><br><span class="line">        &#123;</span><br><span class="line">            //alert(resultNumber);</span><br><span class="line">            document.getElementById(&quot;result&quot;).innerText = resultNumber;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=&quot;background: #CDE; color: #FFF&quot;&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">		&lt;!--title--&gt;</span><br><span class="line">		&lt;font size=&quot;3&quot; color=&quot;black&quot;&gt;输入一个整数：&lt;/font&gt;</span><br><span class="line">		&lt;!--输入框--&gt;</span><br><span class="line">		&lt;textarea id=&quot;input&quot; style=&quot;font-size: 10pt; color: black&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">        &lt;font size=&quot;3&quot; color=&quot;black&quot;&gt;结果： &lt;b id=&quot;result&quot;&gt; &lt;/b&gt; &lt;/font&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">	&lt;div id=&quot;div-a&quot;&gt;</span><br><span class="line">		&lt;center&gt;</span><br><span class="line">			&lt;br/&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; value=&quot;计算阶乘&quot; onclick=&quot;native.calculateForJS(input.value);&quot; /&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">			&lt;br/&gt;</span><br><span class="line">			&lt;input type=&quot;button&quot; value=&quot;测试log&quot; onclick=&quot;log(&apos;测试&apos;);&quot; /&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; value=&quot;oc原生Alert&quot; onclick=&quot;alert(&apos;alert&apos;);&quot; /&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; value=&quot;addSubView&quot; onclick=&quot;addSubView(&apos;view&apos;);&quot; /&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; value=&quot;多参数调用&quot; onclick=&quot;mutiParams(&apos;参数1&apos;,&apos;参数2&apos;,&apos;参数3&apos;);&quot; /&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">            &lt;a id=&quot;push&quot; href=&quot;#&quot; onclick=&quot;native.pushViewControllerTitle(&apos;SecondVC&apos;,&apos;secondPushedFromJS&apos;);&quot;&gt;</span><br><span class="line">                push to second ViewController</span><br><span class="line">            &lt;/a&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">            &lt;br/&gt;</span><br><span class="line">		&lt;/center&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>OC代码</p>
<p>加载上方的Html代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSString *path = [[[NSBundle mainBundle] bundlePath]  stringByAppendingPathComponent:@&quot;JS调用OC.html&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:[NSURL fileURLWithPath:path]];</span><br><span class="line">self.testWebView.delegate = self;</span><br><span class="line">[self.testWebView loadRequest:request];</span><br></pre></td></tr></table></figure>
<p>实现WebView的加载完成代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView&#123;</span><br><span class="line">    // 以 html title 设置 导航栏 title</span><br><span class="line">    self.title = [webView stringByEvaluatingJavaScriptFromString:@&quot;document.title&quot;];</span><br><span class="line">    </span><br><span class="line">    // 禁用 页面元素选择</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:@&quot;document.documentElement.style.webkitUserSelect=&apos;none&apos;;&quot;];</span><br><span class="line"></span><br><span class="line">    // 禁用 长按弹出ActionSheet</span><br><span class="line">    [webView stringByEvaluatingJavaScriptFromString:@&quot;document.documentElement.style.webkitTouchCallout=&apos;none&apos;;&quot;];</span><br><span class="line">    </span><br><span class="line">    //初始化content</span><br><span class="line">    self.context = [webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;];</span><br><span class="line">    </span><br><span class="line">    // 打印异常,由于JS的异常信息是不会在OC中被直接打印的,所以我们在这里添加打印异常信息</span><br><span class="line">    self.context.exceptionHandler = ^(JSContext *context, JSValue *exception) &#123;</span><br><span class="line">        context.exception = exception;</span><br><span class="line">        NSLog(@&quot;___%@&quot;,exception);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    // 以 JSExport 协议关联 native 的方法，这是用JSExport协议调用必须实现的</span><br><span class="line">    self.context[@&quot;native&quot;] = self;</span><br><span class="line">    </span><br><span class="line">    // 以 block 形式关联 JavaScript function</span><br><span class="line">    self.context[@&quot;log&quot;] = ^(NSString *str)&#123;</span><br><span class="line">        NSLog(@&quot;++++%@&quot;,str);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    // 以 block 形式关联 JavaScript function</span><br><span class="line">    __weak __typeof(self)weakSelf = self;</span><br><span class="line">    self.context[@&quot;alert&quot;] =</span><br><span class="line">    ^(NSString *str)</span><br><span class="line">    &#123;</span><br><span class="line">        UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@&quot;msg from js&quot; message:str preferredStyle:UIAlertControllerStyleAlert];</span><br><span class="line">        [alertController addAction:[UIAlertAction actionWithTitle:@&quot;取消&quot; style:UIAlertActionStyleCancel handler:nil]];</span><br><span class="line">        [weakSelf presentViewController:alertController animated:YES completion:nil];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    self.context[@&quot;addSubView&quot;] =</span><br><span class="line">    ^(NSString *viewname)</span><br><span class="line">    &#123;</span><br><span class="line">        //异步调用需要回调到主线程，不然控制台会打印警告log</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            UIView *testView = [[UIView alloc] initWithFrame:CGRectMake(0, 64, 100, 100)];</span><br><span class="line">            testView.backgroundColor = [UIColor redColor];</span><br><span class="line">            UISwitch *sw = [[UISwitch alloc]init];</span><br><span class="line">            [testView addSubview:sw];</span><br><span class="line">            [weakSelf.view addSubview:testView];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    //多参数</span><br><span class="line">    self.context[@&quot;mutiParams&quot;] =</span><br><span class="line">    ^(NSString *a,NSString *b,NSString *c)</span><br><span class="line">    &#123;</span><br><span class="line">        NSLog(@&quot;%@ %@ %@&quot;,a,b,c);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    //直接调用JS的方法</span><br><span class="line">    [self.context evaluateScript:@&quot;mutiParams&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 Block 的坑</p>
<p>使用Block暴露方法很方便，但是有2个坑需要注意一下：</p>
<p>1.不要在Block中直接使用JSValue</p>
<p>2.不要在Block中直接使用JSContext</p>
<p>因为Block会强引用它里面用到的外部变量，如果直接在Block中使用JSValue的话，那么这个JSvalue就会被这个Block强引用，而每个JSValue都是强引用着它所属的那个JSContext的，这是前面说过的，而这个Block又是注入到这个Context中，所以这个Block会被context强引用，这样会造成循环引用，导致内存泄露。不能直接使用JSContext的原因同理。</p>
<p>那怎么办呢，针对第一点，建议把JSValue当做参数传到Block中，而不是直接在Block内部使用，这样Block就不会强引用JSValue了。</p>
<p>针对第二点，可以使用[JSContext currentContext] 方法来获取当前的Context。</p>
<h4 id="JSExport协议"><a href="#JSExport协议" class="headerlink" title="JSExport协议"></a>JSExport协议</h4><p>在.h声明JSExport协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//声明JSExport协议</span><br><span class="line">@protocol TestJSExport &lt;JSExport&gt;</span><br><span class="line">JSExportAs(calculateForJS  /** handleFactorialCalculateWithNumber 作为js方法的别名 */,</span><br><span class="line">- (void)handleFactorialCalculateWithNumber:(NSNumber *)number</span><br><span class="line">);</span><br><span class="line">- (void)pushViewController:(NSString *)view title:(NSString *)title;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>此协议声明了两个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)handleFactorialCalculateWithNumber:(NSNumber *)number</span><br><span class="line"></span><br><span class="line">- (void)pushViewController:(NSString *)view title:(NSString *)title;</span><br></pre></td></tr></table></figure>
<p>对应的会通过JSCore转换成JS<code>calculateForJS</code>的方法和<code>pushViewControllerTitle</code>方法</p>
<p>需要注意的是，OC中的函数声明格式与JS中的不太一样（应该说和大部分语言都不一样。。），OC函数中多个参数是用冒号:声明的，这显然不能直接暴露给JS调用，这不高保真。</p>
<p>所以需要对带参数的方法名做一些调整，当我们暴露一个带参数的OC方法给JS时，JSCore会用以下两个规则生成一个对应的JS函数：</p>
<p>1.移除所有的冒号</p>
<p>2.将跟在冒号后面的第一个小写字母大写</p>
<p>比如上面的那个类方法，转换之前方法名应该是 pushViewController: title:，在JS中生成的对应的方法名就会变成 pushViewControllerTitle。</p>
<p>苹果知道这种不一致可能会逼死某些强迫症。。所以加了一个宏JSExportAs来处理这种情况，它的作用是：给JSCore在JS中为OC方法生成的对应方法指定名字。</p>
<p>比如，还是上面这个方法handleFactorialCalculateWithNumber: number:，可以这样写：calculateForJS</p>
<p>注意：这个宏只对带参数的OC方法有效。</p>
<p>在.m里面实现声明的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">注意这一句话</span><br><span class="line">// 以 JSExport 协议关联 native 的方法</span><br><span class="line">    self.context[@&quot;native&quot;] = self;</span><br><span class="line">    </span><br><span class="line">    #pragma mark - JSExport Methods</span><br><span class="line">//实现JSExport协议声明的计算结果方法</span><br><span class="line">- (void)handleFactorialCalculateWithNumber:(NSNumber *)number</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;, number);</span><br><span class="line">    </span><br><span class="line">    NSNumber *result = [self calculateFactorialOfNumber:number];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%@&quot;, result);</span><br><span class="line">    </span><br><span class="line">    [self.context[@&quot;showResult&quot;] callWithArguments:@[result]];</span><br><span class="line">&#125;</span><br><span class="line">//实现JSExport协议声明的Push页面方法</span><br><span class="line">- (void)pushViewController:(NSString *)view title:(NSString *)title</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        Class second = NSClassFromString(view);</span><br><span class="line">        UIViewController *secondVC = (UIViewController *)[[second alloc]init];</span><br><span class="line">        secondVC.title = title;</span><br><span class="line">        [self.navigationController pushViewController:secondVC animated:YES];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">#pragma mark - Factorial Method</span><br><span class="line">- (NSNumber *)calculateFactorialOfNumber:(NSNumber *)number</span><br><span class="line">&#123;</span><br><span class="line">    NSInteger i = [number integerValue];</span><br><span class="line">    if (i &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        return [NSNumber numberWithInteger:0];</span><br><span class="line">    &#125;</span><br><span class="line">    if (i == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        return [NSNumber numberWithInteger:1];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSInteger r = (i * [(NSNumber *)[self calculateFactorialOfNumber:[NSNumber numberWithInteger:(i - 1)]] integerValue]);</span><br><span class="line">    </span><br><span class="line">    return [NSNumber numberWithInteger:r];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>我们都知道，Objective-C 用的是ARC (Automatic Reference Counting)，不能自动解决循环引用问题(retain cycle)，需要程序员手动处理，而JavaScript 用的是GC (准确的说是 Tracing Garbage Collection)，所有的引用都是强引用，但是垃圾回收器会帮我解决循环引用问题，JavaScriptCore 也一样，一般来说，大多数时候不需要我们去手动管理内存。</p>
<p>但是下面2种情况需要注意一下：</p>
<p>1.不要在JS中给OC对象增加成员变量，这句话的意思就是说，当我们将一个OC对象暴露给JS后，就像前面说的使用JSExport协议，我们能想操纵JS对象一样操纵OC对象，但是这时候，不要在JS中给这个OC对象添加成员变量，因为这个动作产生的后果就是，只会在JS中为这个OC对象增加一个额外的成员变量，但是OC中并不会同步增加。所以说这样做并没有什么意义，还有可能造成一些奇怪的内存管理问题。</p>
<p>2.OC对象不要直接强引用JSValue对象，这句话再说直白点，就是不要直接将一个JSValue类型的对象当成属性或者成员变量保存在一个OC对象中，尤其是这个OC对象还暴露给JS的时候。这样会造成循环引用。</p>
<p>如何解决这个问题呢？你可能会想，不能强引用， 那就弱引用呗，但是这样做也是不行的，因为JSValue没用对象引用他，他就会被释放了。</p>
<p>那怎么办？分析一下，在这里，我们需要一种弱的引用关系，因为强引用会造成循环引用，但是又不能让这个JSValue因无人引用它而被释放。简而言之就是，弱引用但能保持JSValue不被释放。</p>
<p>于是，苹果退出了一种新的引用关系，叫conditional retain，有条件的强引用，通过这种引用就能实现我们前面分析所需要的效果，而JSManagedValue就是苹果用来实现conditional retain的类。</p>
<h4 id="JSManagedValue"><a href="#JSManagedValue" class="headerlink" title="JSManagedValue"></a>JSManagedValue</h4><p>这是JSManagedValue的一般使用步骤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSManagedValue *managedValue = [JSManagedValue managedValueWithValue:jsValue];</span><br><span class="line">[self.context.virtualMachine addManagedReference:managedValue withOwner:self];</span><br></pre></td></tr></table></figure>
<p>1.首先，用JSValue创建一个JSManagedValue对象，JSManagedValue里面其实就是包着一个JSValue对象，可以通过它里面一个只读的value属性取到，这一步其实是添加一个对JSValue的弱引用。</p>
<p>2.如果只有第一步，这个JSValue会在其对应的JS值被垃圾回收器回收之后被释放，这样效果就和弱引用一样，所以还需要加一步，在虚拟机上为这个JSManagedValue对象添加Owner（这个虚拟机就是给JS执行提供资源的，待会再讲），这样做之后，就给JSValue增加一个强关系，只要以下两点有一点成立，这个JSManagedValue里面包含的JSValue就不会被释放：</p>
<p>JSValue对应的JS值没有被垃圾回收器回收</p>
<p>Owner对象没有被释放</p>
<p>看个Demo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">//定义一个JSExport protocol</span><br><span class="line">@protocol JSExportTest &lt;JSExport&gt;</span><br><span class="line">//用来保存JS的对象</span><br><span class="line">@property (nonatomic, strong) JSvalue *jsValue;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//建一个对象去实现这个协议：</span><br><span class="line"></span><br><span class="line">@interface JSProtocolObj : NSObject&lt;JSExportTest&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation JSProtocolObj</span><br><span class="line"></span><br><span class="line">@synthesize jsValue = _jsValue;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//在VC中进行测试</span><br><span class="line">@interface ViewController () &lt;JSExportTest&gt;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) JSProtocolObj *obj;</span><br><span class="line">@property (nonatomic, strong) JSContext *context;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    //创建context</span><br><span class="line">    self.context = [[JSContext alloc] init];</span><br><span class="line">    //设置异常处理</span><br><span class="line">    self.context.exceptionHandler = ^(JSContext *context, JSValue *exception) &#123;</span><br><span class="line">        [JSContext currentContext].exception = exception;</span><br><span class="line">        NSLog(@&quot;exception:%@&quot;,exception);</span><br><span class="line">    &#125;;</span><br><span class="line">   //加载JS代码到context中</span><br><span class="line">   [self.context evaluateScript:</span><br><span class="line">   @&quot;function callback ()&#123;&#125;;</span><br><span class="line">   </span><br><span class="line">    function setObj(obj) &#123;</span><br><span class="line">    this.obj = obj;</span><br><span class="line">    obj.jsValue=callback;</span><br><span class="line">&#125;&quot;];</span><br><span class="line">   //调用JS方法</span><br><span class="line">   [self.context[@&quot;setObj&quot;] callWithArguments:@[self.obj]];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子很简单，调用JS方法，进行赋值，JS对象保留了传进来的obj，最后，JS将自己的回调callback赋值给了obj，方便obj下次回调给JS；由于JS那边保存了obj，而且obj这边也保留了JS的回调。这样就形成了循环引用。</p>
<p>怎么解决这个问题？我们只需要打破obj对JSValue对象的引用即可。当然，不是我们OC中的weak。而是之前说的内存管理辅助对象JSManagedValue。</p>
<p>JSManagedValue 帮助我们保存JSValue，那里面保存的JS对象必须在JS中存在，同时 JSManagedValue 的owner在OC中也存在。</p>
<p>创建JSManagedValue的两种方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (JSManagedValue *)managedValueWithValue:(JSValue *)value;</span><br><span class="line">+ (JSManagedValue *)managedValueWithValue:(JSValue *)value andOwner:(id)owner</span><br></pre></td></tr></table></figure>
<p>建立弱引用关系方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)addManagedReference:(id)object withOwner:(id)owner;</span><br></pre></td></tr></table></figure>
<p>移除弱引用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)removeManagedReference:(id)object withOwner:(id)owner;</span><br></pre></td></tr></table></figure>
<p>修改代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">//定义一个JSExport protocol</span><br><span class="line">@protocol JSExportTest &lt;JSExport&gt;</span><br><span class="line">//用来保存JS的对象</span><br><span class="line">@property (nonatomic, strong) JSValue *jsValue;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//建一个对象去实现这个协议：</span><br><span class="line"></span><br><span class="line">@interface JSProtocolObj : NSObject&lt;JSExportTest&gt;</span><br><span class="line">//添加一个JSManagedValue用来保存JSValue</span><br><span class="line">@property (nonatomic, strong) JSManagedValue *managedValue;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation JSProtocolObj</span><br><span class="line"></span><br><span class="line">@synthesize jsValue = _jsValue;</span><br><span class="line">//重写setter方法</span><br><span class="line">- (void)setJsValue:(JSValue *)jsValue</span><br><span class="line">&#123;</span><br><span class="line">    _managedValue = [JSManagedValue managedValueWithValue:jsValue];</span><br><span class="line">    </span><br><span class="line">    [[[JSContext currentContext] virtualMachine] addManagedReference:_managedValue </span><br><span class="line">    withOwner:self];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//在VC中进行测试</span><br><span class="line">@interface ViewController () &lt;JSExportTest&gt;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) JSProtocolObj *obj;</span><br><span class="line">@property (nonatomic, strong) JSContext *context;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    //创建context</span><br><span class="line">    self.context = [[JSContext alloc] init];</span><br><span class="line">    //设置异常处理</span><br><span class="line">    self.context.exceptionHandler = ^(JSContext *context, JSValue *exception) &#123;</span><br><span class="line">        [JSContext currentContext].exception = exception;</span><br><span class="line">        NSLog(@&quot;exception:%@&quot;,exception);</span><br><span class="line">    &#125;;</span><br><span class="line">   //加载JS代码到context中</span><br><span class="line">   [self.context evaluateScript:</span><br><span class="line">   @&quot;function callback ()&#123;&#125;; </span><br><span class="line">   </span><br><span class="line">   function setObj(obj) &#123;</span><br><span class="line">   this.obj = obj;</span><br><span class="line">   obj.jsValue=callback;</span><br><span class="line">   &#125;&quot;];</span><br><span class="line">   //调用JS方法</span><br><span class="line">   [self.context[@&quot;setObj&quot;] callWithArguments:@[self.obj]];</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后一点</p>
<p>一个 JSVirtualMachine可以运行多个context，由于都是在同一个堆内存和同一个垃圾回收下，所以相互之间传值是没问题的。但是如果在不同的 JSVirtualMachine传值，垃圾回收就不知道他们之间的关系了，可能会引起异常。</p>
<p><a href="https://github.com/NoLiuxin/JavaScriptCoreDemo" target="_blank" rel="noopener">本文章Demo地址</a></p>
<p>参考：<a href="https://github.com/phoboslab/JavaScriptCore-iOS" target="_blank" rel="noopener">http://www.cocoachina.com/ios/20170720/19958.html</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JavaScriptCore/" rel="tag"># JavaScriptCore</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/26/WebViewJavascriptBridge使用和原理剖析/" rel="next" title="WebViewJavascriptBridge使用和原理剖析">
                <i class="fa fa-chevron-left"></i> WebViewJavascriptBridge使用和原理剖析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/12/UIView以自身的某一点为圆心进行旋转/" rel="prev" title="UIView以自身的某一点为圆心进行旋转">
                UIView以自身的某一点为圆心进行旋转 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2017/12/27/JavaScriptCore使用/"
           data-title="JavaScriptCore使用" data-url="http://www.521ios.com/2017/12/27/JavaScriptCore使用/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://pic2.52pk.com/files/141002/1283574_134905_7693.jpg"
                alt="LiuXin" />
            
              <p class="site-author-name" itemprop="name">LiuXin</p>
              <p class="site-description motion-element" itemprop="description">编程如逆水行舟，不进则退</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#JavaScriptCore"><span class="nav-number">1.</span> <span class="nav-text">JavaScriptCore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSContext"><span class="nav-number">2.</span> <span class="nav-text">JSContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSValue"><span class="nav-number">3.</span> <span class="nav-text">JSValue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OC调用JS"><span class="nav-number">4.</span> <span class="nav-text">OC调用JS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JS调用OC"><span class="nav-number">5.</span> <span class="nav-text">JS调用OC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Block方式"><span class="nav-number">5.1.</span> <span class="nav-text">Block方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSExport协议"><span class="nav-number">5.2.</span> <span class="nav-text">JSExport协议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理"><span class="nav-number">6.</span> <span class="nav-text">内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSManagedValue"><span class="nav-number">6.1.</span> <span class="nav-text">JSManagedValue</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiuXin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"liuxinzkj"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  

  

  
  

  

  

  

</body>
</html>
